<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Blog - All Posts</title>
  <style>
    /* preserve your styles, with small additions for comments and likes */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Montserrat", Lato;background:#EAEAEA;min-height:100vh}
    .navbar{background:linear-gradient(135deg,#757575 0%,#1E1E1E 100%);color:#EAEAEA;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px #3C3C3C;flex-wrap:wrap;gap:10px}
    .navbar-brand{font-size:24px;font-weight:bold;flex-shrink:0}
    .navbar-links{display:flex;gap:20px;align-items:center;flex-shrink:0}
    .nav-link{color:#EAEAEA;text-decoration:none;padding:6px 12px;border-radius:15px;transition:all .3s;cursor:pointer;font-size:13px;white-space:nowrap}
    .nav-link:hover{background:rgba(255,255,255,.2)}
    .nav-link.primary{background:#EAEAEA;color:#1E1E1E;font-weight:600}
    .hero{background:linear-gradient(135deg,#757575 0%,#1E1E1E 100%);color:#EAEAEA;padding:60px 20px;text-align:center}
    .hero h1{font-size:48px;margin-bottom:15px}
    .hero p{font-size:18px;opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:40px 20px}
    .posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:30px}
    .post-card{background:#EAEAEA;border-radius:15px;padding:30px;box-shadow:0 2px 15px #3C3C3C;transition:transform .3s,box-shadow .3s}
    .post-card:hover{transform:translateY(-5px);box-shadow:0 8px 25px #3C3C3C}
    .post-header{margin-bottom:15px}
    .post-card h2{color:#1E1E1E;margin-bottom:10px;font-size:24px}
    .post-author{color:#1E1E1E;font-weight:600;font-size:14px;margin-bottom:5px}
    .post-date{color:#757575;font-size:13px}
    .post-content{color:#1E1E1E;line-height:1.8;margin-bottom:20px;max-height:200px;overflow:auto}
    .post-images{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .post-images img{width:100%;border-radius:10px;object-fit:cover;max-height:250px}
    .post-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding-top:15px;border-top:1px solid #EAEAEA}
    .action-btn{background:#EAEAEA;border:1px solid #EAEAEA;padding:8px 15px;border-radius:20px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:5px;transition:all .3s}
    .action-btn:hover{background:#3C3C3C;color:#EAEAEA;border-color:#3C3C3C}
    .action-btn.liked{background:#ff4757;color:#EAEAEA;border-color:#ff4757}
    .action-btn .icon{font-size:16px}
    .read-more-btn{background:linear-gradient(135deg,#757575 0%,#1E1E1E 100%);color:white;border:none;padding:10px 25px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:600;transition:transform .2s;margin-left:auto}
    .read-more-btn:hover{transform:translateY(-2px)}
    .loading{text-align:center;padding:60px 20px;color:#999;font-size:18px}
    .empty-state{text-align:center;padding:80px 20px;color:#999}
    .empty-state h3{font-size:28px;margin-bottom:15px}
    .empty-state p{font-size:16px}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(60,60,60,0.95);z-index:1000;overflow-y:auto}
    .modal.active{display:flex;justify-content:center;align-items:center;padding:20px}
    .modal-content{background:#EAEAEA;border-radius:15px;width:100%;max-width:800px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px #3C3C3C}
    .modal-header{padding:30px;border-bottom:2px solid #ddd}
    .modal-header h2{color:#333;font-size:32px;margin-bottom:15px}
    .modal-meta{display:flex;gap:20px;color:#666;font-size:14px}
    .modal-body{padding:30px}
    .modal-body p{color:#444;line-height:1.8;font-size:16px;white-space:pre-wrap}
    .modal-images{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
    .modal-images img{width:100%;border-radius:12px;object-fit:cover}
    .modal-actions{padding:20px 30px;border-top:2px solid #f0f0f0;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .close-modal-btn{position:sticky;top:0;background:white;padding:15px 30px;border-top:2px solid #2A2A2A;text-align:right}
    .close-modal-btn button{background:#EAEAEA;border:none;padding:10px 30px;border-radius:8px;cursor:pointer;font-weight:600;color:#1E1E1E}
    .close-modal-btn button:hover{background:#3C3C3C}
    .comments{margin-top:12px;border-top:1px dashed #e2e2e2;padding-top:12px}
    .comment{padding:8px 0;border-bottom:1px solid #f4f4f4}
    .comment .meta{font-size:12px;color:#777}
    .comment-input{display:flex;gap:8px;margin-top:10px}
    .comment-input textarea{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd;min-height:40px}
    .comment-input button{padding:8px 12px;border-radius:8px;border:none;background:#2A2A2A;color:white;cursor:pointer}
    .small-muted{font-size:12px;color:#999;font-style:italic}
    @media(max-width:768px){.navbar{padding:10px 15px}.navbar-brand{font-size:18px}.hero h1{font-size:32px}.posts-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-brand">Aeden</div>
    <div class="navbar-links">
      <a href="index.html" class="nav-link">Home</a>
      <a href="blog.html" class="nav-link">All Posts</a>
      <div id="auth-links">
        <a href="auth.html" class="nav-link primary">Login</a>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <h1>Explore Our Blog</h1>
    <p>Discover insights, stories, and perspectives from our community.</p>
  </section>

  <!-- Main -->
  <div class="container">
    <div id="posts-container" class="posts-grid">
      <div class="loading">Loading posts...</div>
    </div>
  </div>

  <!-- Modal for full post -->
  <div id="post-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title"></h2>
        <div class="modal-meta">
          <span id="modal-author"></span>
          <span id="modal-date"></span>
        </div>
      </div>
      <div class="modal-body">
        <div id="modal-content"></div>
        <div id="modal-images" class="modal-images"></div>

        <div class="comments">
          <h3>Comments</h3>
          <div id="modal-comments"></div>
          <div class="comment-input">
            <textarea id="modal-comment-text" placeholder="Write a comment..."></textarea>
            <button id="modal-comment-btn">Comment</button>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="action-btn" id="modal-like-btn">
          <span class="icon">‚ù§Ô∏è</span>
          <span id="modal-like-count">0</span> Likes
        </button>
        <button class="action-btn" id="modal-share-btn"><span class="icon">üì§</span>Share</button>
        <button class="action-btn" onclick="window.location.href='subscribe.html'"><span class="icon">üìß</span>Subscribe</button>
      </div>
      <div class="close-modal-btn">
        <button onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import {
      getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, addDoc,
      arrayUnion, arrayRemove, serverTimestamp, getDoc
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
  
    // same config
    const firebaseConfig = {
      apiKey: "AIzaSyB34DhbeaIzmRFowWayXLgR68Zlv-dOqQA",
      authDomain: "aeden-168f6.firebaseapp.com",
      projectId: "aeden-168f6",
      storageBucket: "aeden-168f6.firebasestorage.app",
      messagingSenderId: "559755104565",
      appId: "1:559755104565:web:9e0fc3c6c58f985c05bc7c",
      measurementId: "G-K8R4B6EF1T"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  
    // expose
    window.firebaseAuth = auth;
    window.firebaseDb = db;
  
    const postsContainer = document.getElementById('posts-container');
  
    // real-time posts listener
    const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
    onSnapshot(postsQuery, (snapshot) => {
      const posts = [];
      snapshot.forEach(snap => posts.push({ id: snap.id, ...snap.data() }));
      renderPosts(posts);
    }, (err) => {
      console.error('Posts onSnapshot error:', err);
      postsContainer.innerHTML = `<div class="empty-state"><h3>Error loading posts</h3><p>Please refresh the page.</p></div>`;
    });
  
    // update auth UI links
    onAuthStateChanged(auth, (user) => {
      const authLinks = document.getElementById('auth-links');
      if (user) {
        authLinks.innerHTML = `<a href="dashboard.html" class="nav-link">My Dashboard</a><a href="#" class="nav-link primary" onclick="handleLogout(); return false;">Logout</a>`;
        window.currentUser = user;
      } else {
        authLinks.innerHTML = `<a href="auth.html" class="nav-link primary">Login</a>`;
        window.currentUser = null;
      }
    });
  
    // render posts
    let postsState = [];
    function renderPosts(posts) {
      postsState = posts;
      if (!posts || posts.length === 0) {
        postsContainer.innerHTML = `<div class="empty-state"><h3>No posts yet</h3><p>Be the first to share your thoughts!</p></div>`;
        return;
      }
      postsContainer.innerHTML = '';
      posts.forEach(post => postsContainer.innerHTML += createPostCard(post));
    }
  
    function createPostCard(post) {
      const date = post.createdAt && post.createdAt.toDate ? post.createdAt.toDate().toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : (post.createdAt ? new Date(post.createdAt).toLocaleDateString() : '');
      const excerpt = (post.content || '').replace(/<\/?[^>]+(>|$)/g, '').slice(0,200) + ((post.content && post.content.length>200)?'...':'');
      const imagesHtml = post.images && post.images.length ? `<div class="post-images">${post.images.map(img=>`<img src="${img.url}" alt="Post image">`).join('')}</div>` : '';
      const likesCount = Array.isArray(post.likes) ? post.likes.length : (post.likes || 0);
      const likedClass = (window.currentUser && Array.isArray(post.likes) && post.likes.includes(window.currentUser.uid)) ? 'liked' : '';
      
      // Get comments count from array
      const commentsCount = Array.isArray(post.comments) ? post.comments.length : 0;
      const commentsPreview = Array.isArray(post.comments) && post.comments.length > 0 
        ? post.comments.slice(-2).reverse().map(c => `<div class="comment"><div class="meta">${escapeHtml(c.authorName || 'Someone')} ‚Ä¢ ${c.createdAt ? formatTimestamp(c.createdAt) : ''}</div><div>${escapeHtml(c.text)}</div></div>`).join('')
        : '<div class="small-muted">Be the first to comment</div>';
      
      return `
        <div class="post-card" id="post-${post.id}">
          <div class="post-header">
            <h2>${escapeHtml(post.title)}</h2>
            <div class="post-author">By ${escapeHtml(post.authorName || 'Unknown')}</div>
            <div class="post-date">${date}</div>
          </div>
          ${imagesHtml}
          <div class="post-content">${truncateHtml(post.content, 300)}</div>
          <div class="post-actions">
            <button class="action-btn ${likedClass}" onclick="toggleLike('${post.id}', event)">
              <span class="icon">‚ù§Ô∏è</span>
              <span id="likes-${post.id}">${likesCount}</span>
            </button>
            <button class="action-btn" onclick="sharePostQuick('${post.id}')"><span class="icon">üì§</span>Share</button>
            <button class="action-btn" onclick="window.location.href='subscribe.html'"><span class="icon">üìß</span>Subscribe</button>
            <button class="read-more-btn" onclick="openModal('${post.id}')">Read Full Post</button>
          </div>
          <div class="comments">
            ${commentsPreview}
            ${commentsCount > 2 ? `<div class="small-muted">+ ${commentsCount - 2} more comments ‚Äî open post to view all</div>` : ''}
          </div>
        </div>
      `;
    }
  
    // helper: basic HTML truncation (keeps tags)
    function truncateHtml(html, maxLen) {
      if (!html) return '';
      const temp = document.createElement('div');
      temp.innerHTML = html;
      const text = temp.textContent || temp.innerText || '';
      if (text.length <= maxLen) return escapeHtml(text);
      return escapeHtml(text.slice(0, maxLen)) + '...';
    }
  
    // helper: format timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      if (timestamp.toDate) return timestamp.toDate().toLocaleString();
      if (timestamp.seconds) return new Date(timestamp.seconds * 1000).toLocaleString();
      return new Date(timestamp).toLocaleString();
    }
  
    // open modal
    let currentPostId = null;
    function openModal(postId) {
      const post = postsState.find(p => p.id === postId);
      if (!post) return;
      currentPostId = postId;
      
      // ‚úÖ FIX: Set aria-hidden to false when modal opens
      const modal = document.getElementById('post-modal');
      modal.setAttribute('aria-hidden', 'false');
      
      document.getElementById('modal-title').textContent = post.title;
      document.getElementById('modal-author').textContent = `By ${post.authorName || 'Unknown'}`;
      const date = post.createdAt && post.createdAt.toDate ? post.createdAt.toDate().toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : '';
      document.getElementById('modal-date').textContent = date;
      
      // ‚úÖ IMPROVED: Show content as HTML (preserves inline images and formatting)
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = post.content || '';
      
      // images rendered separately (gallery images only)
      const modalImages = document.getElementById('modal-images');
      if (post.images && post.images.length) {
        modalImages.innerHTML = post.images.map(img => `<img src="${img.url}" alt="Post image">`).join('');
      } else modalImages.innerHTML = '';
      
      // like count
      const likesCount = Array.isArray(post.likes) ? post.likes.length : (post.likes || 0);
      document.getElementById('modal-like-count').textContent = likesCount;
      
      // Update like button style
      const modalLikeBtn = document.getElementById('modal-like-btn');
      if (window.currentUser && Array.isArray(post.likes) && post.likes.includes(window.currentUser.uid)) {
        modalLikeBtn.classList.add('liked');
      } else {
        modalLikeBtn.classList.remove('liked');
      }
      
      // Load comments from array in post document
      loadModalComments(post);
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  
    // Load comments from post.comments array
    // now includes edit/delete buttons for comment authors
    function loadModalComments(post) {
      const comments = Array.isArray(post.comments) ? post.comments : [];
      const commentsEl = document.getElementById('modal-comments');
      
      if (comments.length === 0) {
        commentsEl.innerHTML = '<div class="small-muted">No comments yet</div>';
        return;
      }
  
      // build html with controls for the author of each comment
      commentsEl.innerHTML = comments.map(c => {
        // ensure each comment has an id (older comments might not)
        const id = c.id || (c.createdAt ? `${c.authorId}-${new Date(c.createdAt).getTime()}` : `${c.authorId}-${Math.random().toString(36).slice(2,9)}`);
        const authorIsCurrent = window.currentUser && window.currentUser.uid === c.authorId;
        // normal view
        const viewHtml = `
          <div class="meta">${escapeHtml(c.authorName || 'Someone')} ‚Ä¢ ${c.createdAt ? formatTimestamp(c.createdAt) : ''}</div>
          <div class="text">${escapeHtml(c.text)}</div>
        `;
        // controls if author
        const controls = authorIsCurrent ? `
          <div class="comment-controls">
            <button class="btn-small" onclick="startEditComment('${escapeHtml(id)}')">Edit</button>
            <button class="btn-small btn-danger" onclick="deleteComment('${escapeHtml(id)}')">Delete</button>
          </div>
        ` : '';
        // store the comment id as data-* for reference in DOM (helps when editing)
        return `
          <div class="comment" data-comment-id="${escapeHtml(id)}" data-author-id="${escapeHtml(c.authorId || '')}">
            ${viewHtml}
            ${controls}
          </div>
        `;
      }).join('');
    }
  
    // close
    function closeModal() {
      const modal = document.getElementById('post-modal');
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true'); // ‚úÖ FIX: Set aria-hidden to true when closing
      document.body.style.overflow = 'auto';
      currentPostId = null;
      document.getElementById('modal-comment-text').value = '';
    }
  
    // toggling likes (arrayUnion / arrayRemove)
    async function toggleLike(postId, event) {
      if (event) event.stopPropagation();
      if (!window.currentUser) {
        alert('Please login to like posts!');
        window.location.href = 'auth.html';
        return;
      }
      try {
        const postRef = doc(db, 'posts', postId);
        const post = postsState.find(p => p.id === postId);
        const likes = Array.isArray(post.likes) ? post.likes : [];
        const uid = window.currentUser.uid;
        if (likes.includes(uid)) {
          await updateDoc(postRef, { likes: arrayRemove(uid) });
        } else {
          await updateDoc(postRef, { likes: arrayUnion(uid) });
        }
        // UI will update in realtime via posts onSnapshot
      } catch (err) {
        console.error('Error toggling like:', err);
      }
    }
  
    // modal like (similar)
    document.getElementById('modal-like-btn').addEventListener('click', async (e) => {
      if (!currentPostId) return;
      e.stopPropagation();
      
      if (!window.currentUser) {
        alert('Please login to like posts!');
        window.location.href = 'auth.html';
        return;
      }
      
      try {
        const postRef = doc(db, 'posts', currentPostId);
        const post = postsState.find(p => p.id === currentPostId);
        const likes = Array.isArray(post.likes) ? post.likes : [];
        const uid = window.currentUser.uid;
        
        if (likes.includes(uid)) {
          await updateDoc(postRef, { likes: arrayRemove(uid) });
        } else {
          await updateDoc(postRef, { likes: arrayUnion(uid) });
        }
        
        // UI will update in realtime via posts onSnapshot, but we can also update modal immediately
        const updatedPost = postsState.find(p => p.id === currentPostId);
        if (updatedPost) {
          const newLikesCount = Array.isArray(updatedPost.likes) ? updatedPost.likes.length : 0;
          document.getElementById('modal-like-count').textContent = newLikesCount;
          
          const modalLikeBtn = document.getElementById('modal-like-btn');
          if (updatedPost.likes && updatedPost.likes.includes(uid)) {
            modalLikeBtn.classList.add('liked');
          } else {
            modalLikeBtn.classList.remove('liked');
          }
        }
      } catch (err) {
        console.error('Error toggling like:', err);
        alert('Failed to like post. Please try again.');
      }
    });
  
    // share
    function sharePostQuick(postId) {
      const post = postsState.find(p => p.id === postId);
      if (!post) return;
      const shareText = `Check out this post: ${post.title}`;
      const shareUrl = `${window.location.origin}/blog.html#post-${postId}`;
      if (navigator.share) {
        navigator.share({ title: post.title, text: shareText, url: shareUrl }).catch(err => console.log(err));
      } else {
        navigator.clipboard.writeText(shareUrl);
        alert('Link copied to clipboard!');
      }
    }
  
    // modal share button
    document.getElementById('modal-share-btn').addEventListener('click', () => {
      if (currentPostId) sharePostQuick(currentPostId);
    });
  
    // -----------------------------
    // COMMENTS: Add / Edit / Delete
    // -----------------------------
    // Helper: generate a reasonably-unique id for comment (works in browsers)
    function generateCommentId() {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'c-' + Date.now() + '-' + Math.random().toString(36).slice(2,9);
    }
  
    // Add comment (reads latest doc to avoid duplicates and then updates with full array)
    document.getElementById('modal-comment-btn').addEventListener('click', async () => {
      const textEl = document.getElementById('modal-comment-text');
      const text = textEl.value.trim();
      if (!text) return;
      if (!window.currentUser) { 
        alert('Please login to comment'); 
        window.location.href='auth.html'; 
        return; 
      }
      try {
        const postRef = doc(db, 'posts', currentPostId);
        // fetch latest post doc to get up-to-date comments
        const snapshot = await getDoc(postRef);
        const postData = snapshot.exists() ? snapshot.data() : {};
        const existingComments = Array.isArray(postData.comments) ? postData.comments : [];
  
        const newComment = {
          id: generateCommentId(),
          text,
          authorId: window.currentUser.uid,
          authorName: window.currentUser.displayName || window.currentUser.email,
          createdAt: new Date().toISOString()
        };
  
        const newCommentsArray = [...existingComments, newComment];
  
        // update whole comments array (ensures single insertion)
        await updateDoc(postRef, { comments: newCommentsArray });
  
        // clear input
        textEl.value = '';
  
        // local optimistic update (will be replaced by realtime update shortly)
        const postInState = postsState.find(p => p.id === currentPostId);
        if (postInState) {
          if (!Array.isArray(postInState.comments)) postInState.comments = [];
          postInState.comments.push(newComment);
          loadModalComments(postInState);
        }
      } catch (err) {
        console.error('Error adding comment', err);
        alert('Failed to add comment');
      }
    });
  
    // Start editing: replace the comment DOM with an edit UI
    window.startEditComment = function(commentId) {
      if (!currentPostId) return;
      const post = postsState.find(p => p.id === currentPostId);
      if (!post) return;
      const commentsEl = document.getElementById('modal-comments');
      const commentNode = commentsEl.querySelector(`[data-comment-id="${commentId}"]`);
      if (!commentNode) return;
  
      // find the comment object
      const commentObj = (post.comments || []).find(c => (c.id || (c.createdAt ? `${c.authorId}-${new Date(c.createdAt).getTime()}` : '')) === commentId);
      if (!commentObj) return;
      if (!window.currentUser || window.currentUser.uid !== commentObj.authorId) {
        alert('You can only edit your own comments.');
        return;
      }
  
      // render edit UI
      commentNode.innerHTML = `
        <div class="meta">${escapeHtml(commentObj.authorName || 'You')} ‚Ä¢ ${commentObj.createdAt ? formatTimestamp(commentObj.createdAt) : ''}</div>
        <textarea class="edit-comment-text" rows="3">${escapeHtml(commentObj.text)}</textarea>
        <div class="comment-edit-actions">
          <button class="btn-small" onclick="saveEditedComment('${commentId}')">Save</button>
          <button class="btn-small" onclick="cancelEditComment('${commentId}')">Cancel</button>
        </div>
      `;
    };
  
    // Cancel edit: re-render modal comments from postsState
    window.cancelEditComment = function(commentId) {
      const post = postsState.find(p => p.id === currentPostId);
      if (post) loadModalComments(post);
    };
  
    // Save edited comment: fetch latest comments, modify, update entire array
    window.saveEditedComment = async function(commentId) {
      if (!currentPostId) return;
      const postRef = doc(db, 'posts', currentPostId);
      try {
        const commentsEl = document.getElementById('modal-comments');
        const commentNode = commentsEl.querySelector(`[data-comment-id="${commentId}"]`);
        if (!commentNode) return;
        const textarea = commentNode.querySelector('.edit-comment-text');
        if (!textarea) return;
        const newText = textarea.value.trim();
        if (!newText) { alert('Comment cannot be empty'); return; }
  
        // Get latest post comments
        const snapshot = await getDoc(postRef);
        const postData = snapshot.exists() ? snapshot.data() : {};
        const existingComments = Array.isArray(postData.comments) ? postData.comments : [];
  
        // find and update
        const updatedComments = existingComments.map(c => {
          const cId = c.id || (c.createdAt ? `${c.authorId}-${new Date(c.createdAt).getTime()}` : '');
          if (cId === commentId) {
            // only allow author to edit
            if (!window.currentUser || window.currentUser.uid !== c.authorId) {
              throw new Error('Unauthorized');
            }
            return { ...c, text: newText, editedAt: new Date().toISOString() };
          }
          return c;
        });
  
        // push update
        await updateDoc(postRef, { comments: updatedComments });
  
        // optimistic local update
        const postInState = postsState.find(p => p.id === currentPostId);
        if (postInState) {
          postInState.comments = updatedComments;
          loadModalComments(postInState);
        }
      } catch (err) {
        console.error('Error saving edited comment', err);
        alert('Failed to save edited comment.');
        // reload local to ensure consistent UI
        const postInState = postsState.find(p => p.id === currentPostId);
        if (postInState) loadModalComments(postInState);
      }
    };
  
    // Delete comment: confirm + fetch latest + remove + update whole array
    window.deleteComment = async function(commentId) {
      if (!currentPostId) return;
      if (!confirm('Delete this comment?')) return;
      const postRef = doc(db, 'posts', currentPostId);
      try {
        const snapshot = await getDoc(postRef);
        const postData = snapshot.exists() ? snapshot.data() : {};
        const existingComments = Array.isArray(postData.comments) ? postData.comments : [];
  
        // find comment to check authorship
        const commentToDelete = existingComments.find(c => (c.id || (c.createdAt ? `${c.authorId}-${new Date(c.createdAt).getTime()}` : '')) === commentId);
        if (!commentToDelete) {
          alert('Comment not found');
          return;
        }
        if (!window.currentUser || window.currentUser.uid !== commentToDelete.authorId) {
          alert('You can only delete your own comments.');
          return;
        }
  
        const updatedComments = existingComments.filter(c => {
          const cId = c.id || (c.createdAt ? `${c.authorId}-${new Date(c.createdAt).getTime()}` : '');
          return cId !== commentId;
        });
  
        await updateDoc(postRef, { comments: updatedComments });
  
        // optimistic local update
        const postInState = postsState.find(p => p.id === currentPostId);
        if (postInState) {
          postInState.comments = updatedComments;
          loadModalComments(postInState);
        }
      } catch (err) {
        console.error('Error deleting comment', err);
        alert('Failed to delete comment');
      }
    };
  
    // -----------------------------
    // global helpers
    // -----------------------------
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  
    // close modal by background
    document.getElementById('post-modal').addEventListener('click', function(e) { 
      if (e.target === this) closeModal(); 
    });
    
    document.addEventListener('keydown', (e)=> { 
      if (e.key === 'Escape') closeModal(); 
    });
  
    // handle logout
    window.handleLogout = async function() { 
      if(confirm('Logout?')) { 
        try { 
          await auth.signOut(); 
          window.location.href='auth.html'; 
        } catch(e) {
          console.error(e);
        } 
      } 
    };
  
    // Expose functions globally for inline onclick handlers
    window.toggleLike = toggleLike;
    window.sharePostQuick = sharePostQuick;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.startEditComment = startEditComment;
    window.saveEditedComment = saveEditedComment;
    window.cancelEditComment = cancelEditComment;
    window.deleteComment = deleteComment;
  
  </script>
  
</body>
</html>