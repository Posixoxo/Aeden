<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - My Posts</title>
  <style>
    /* === your existing styles (mostly preserved) === */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Montserrat", Lato;background:#EAEAEA;min-height:100vh}
    .navbar{background-color:#1E1E1E;color:#EAEAEA;padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px #3C3C3C}
    .navbar-brand{font-size:24px;font-weight:bold}
    .navbar-brand a{color:#EAEAEA; text-decoration:none}
    .navbar-user{display:flex;align-items:center;gap:15px}
    .user-name{font-size:16px}
    .logout-btn{background:#2A2A2A;color:#EAEAEA;border:1px solid #EAEAEA;padding:8px 20px;border-radius:20px;cursor:pointer;transition:all .3s}
    .logout-btn:hover{background:#EAEAEA;color:#3C3C3C}
    .container{max-width:1200px;margin:0 auto;padding:40px 20px}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    .dashboard-header h1{color:#1E1E1E;font-size:32px}
    .new-post-btn{background-color:#2A2A2A;color:#EAEAEA;border:none;padding:12px 30px;border-radius:25px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 4px 15px #3C3C3C;transition:transform .2s}
    .new-post-btn:hover{transform:translateY(-2px)}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#757575;z-index:1000;overflow-y:auto}
    .modal.active{display:flex;justify-content:center;align-items:center;padding:20px}
    .modal-content{background:#EAEAEA;border-radius:15px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px #3C3C3C}
    .modal-header{padding:25px;border-bottom:1px solid #EAEAEA;display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{color:#333}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#999}
    .modal-body{padding:25px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:#333;font-weight:600}
    .form-group input,.form-group textarea{width:100%;padding:12px;border:2px solid #EAEAEA;border-radius:8px;font-size:15px;font-family:inherit}
    .form-group textarea{min-height:200px;resize:vertical}
    .form-group input:focus,.form-group textarea:focus{outline:none;border-color:#1E1E1E}
    .modal-footer{padding:20px 25px;border-top:1px solid #EAEAEA;display:flex;gap:10px;justify-content:flex-end}
    .btn{padding:10px 25px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s}
    .btn-primary{background:linear-gradient(135deg,#757575 0%,#1E1E1E 100%);color:#EAEAEA;border:none}
    .btn-secondary{background:#EAEAEA;color:#757575;border:none}
    .posts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:25px}
    .post-card{background:#EAEAEA;border-radius:12px;padding:25px;box-shadow:0 2px 10px #3C3C3C;transition:transform .3s,box-shadow .3s}
    .post-card:hover{transform:translateY(-5px);box-shadow:0 5px 20px #3C3C3C}
    .post-card h3{color:#333;margin-bottom:12px;font-size:20px}
    .post-content{color:#666;line-height:1.6;margin-bottom:15px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .post-meta{font-size:13px;color:#999;margin-bottom:15px}
    .post-actions{display:flex;gap:10px}
    .btn-small{padding:6px 15px;font-size:13px;border-radius:6px;border:none;cursor:pointer;transition:all .3s}
    .btn-edit{background:#2A2A2A;color:#EAEAEA;border-radius:10px}
    .btn-delete{background:#2A2A2A;color:#EAEAEA;border-radius:10px}
    .empty-state{text-align:center;padding:60px 20px;color:#999}
    .empty-state h3{font-size:24px;margin-bottom:10px}
    .loading{text-align:center;padding:40px;color:#999}
    .foot{text-align: center; justify-content: center; align-items: center; margin: 150px auto;}
    .foot a{color: #1E1E1E; text-decoration: none; font-size: 16px; font-family: "Montserrat", Lato; font-weight: 600;}

    /* === additions for image preview, editor, thumbnails === */
    .editor-toolbar{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .editor-btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .editor{min-height:220px;padding:12px;border:2px solid #EAEAEA;border-radius:8px;background:#fff;overflow:auto}
    .image-preview-grid{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:110px;height:80px;border-radius:8px;overflow:hidden;position:relative;border:1px solid #ddd;background:#f7f7f7;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:6px;padding:3px 6px;cursor:pointer}
    .thumb .move{position:absolute;bottom:6px;left:6px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:6px;padding:3px 6px;cursor:pointer;font-size:12px}
    .thumb .move-right{left:auto;right:36px}
    .small-muted{font-size:13px;color:#777;margin-top:8px}
    .insert-img-input{display:none}
    @media(max-width:768px){.modal-content{max-width:95%}}
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand"><a href="blog.html">Dashboard</a></div>
    <div class="navbar-user">
      <span class="user-name" id="user-name">Loading...</span>
      <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>
  </nav>

  <div class="container">
    <div class="dashboard-header">
      <h1>My Posts</h1>
      <button class="new-post-btn" onclick="openPostModal()">+ New Post</button>
    </div>

    <div id="posts-container" class="posts-grid">
      <div class="loading">Loading your posts...</div>
    </div>
  </div>

  <!-- Post Modal -->
  <div id="post-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 id="modal-title">Create New Post</h2>
        <button class="close-btn" onclick="closePostModal()">&times;</button>
      </div>

      <form id="post-form" onsubmit="handlePostSubmit(event)">
        <div class="modal-body">
          <div class="form-group">
            <label>Title</label>
            <input type="text" id="post-title" required placeholder="Enter your post title" />
          </div>

          <div class="form-group">
            <label>Content</label>
            <div class="editor-toolbar">
              <button type="button" class="editor-btn" onclick="formatText('bold')"><strong>B</strong></button>
              <button type="button" class="editor-btn" onclick="formatText('italic')"><em>I</em></button>
              <button type="button" class="editor-btn" onclick="formatText('createLink')">Link</button>
              <button type="button" class="editor-btn" onclick="triggerImageInsert()">Insert Image</button>
              <input id="insert-image-file" class="insert-img-input" type="file" accept="image/*" onchange="handleInsertImage(event)">
            </div>
            <div id="post-editor" class="editor" contenteditable="true" placeholder="Write your content..."></div>
            <div class="small-muted">Tip: paste text or use toolbar. Images you insert appear inline and in the preview thumbnails below.</div>
          </div>

          <div class="form-group">
            <label>Images (preview, reorder, remove)</label>
            <div>
              <input id="file-multiple" type="file" accept="image/*" multiple onchange="handleMultiSelect(event)" />
              <div class="small-muted">You can select multiple files. They’ll be uploaded on Publish. Use the arrow buttons to reorder thumbnails.</div>
            </div>
            <div id="image-preview" class="image-preview-grid" aria-live="polite"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePostModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">Publish Post</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="foot">
    <a href="blog.html">&#8592;Back to Blog</a>
  </footer>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, query, where, getDocs, doc, updateDoc, deleteDoc,
      onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
  
    // FIREBASE CONFIG (same project)
    const firebaseConfig = {
      apiKey: "AIzaSyB34DhbeaIzmRFowWayXLgR68Zlv-dOqQA",
      authDomain: "aeden-168f6.firebaseapp.com",
      projectId: "aeden-168f6",
      storageBucket: "aeden-168f6.firebasestorage.app",
      messagingSenderId: "559755104565",
      appId: "1:559755104565:web:9e0fc3c6c58f985c05bc7c",
      measurementId: "G-K8R4B6EF1T"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  
    // Cloudinary config - CORRECTED (as you specified)
    const CLOUDINARY_CLOUD_NAME = "db8qufy9q"; 
    const CLOUDINARY_UPLOAD_PRESET = "aeden_unsigned";  
  
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
  
    // expose for inline scripts (keeps your earlier approach)
    window.firebaseAuth = auth;
    window.firebaseDb = db;
  
    // local state
    let editingPostId = null;
    let allUserPosts = [];
    // stagedImages entries: { file?, localPreview, urlPreview, cloudPublicId?, name, order, isInline? }
    let stagedImages = [];
    const postsContainer = document.getElementById('posts-container');
    const editor = document.getElementById('post-editor');
  
    // auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('user-name').textContent = user.displayName || user.email;
        window.currentUser = user;
        loadUserPostsRealtime();
      } else {
        // redirect to auth if not logged in
        window.location.href = 'auth.html';
      }
    });
  
    // ===== Real-time load of user posts (keeps dashboard reactive) =====
    function loadUserPostsRealtime() {
      const q = query(collection(db, 'posts'), where('authorId', '==', window.currentUser.uid), orderBy('createdAt', 'desc'));
      // use onSnapshot to stay in sync
      onSnapshot(q, (snapshot) => {
        const posts = [];
        snapshot.forEach(docSnap => posts.push({ id: docSnap.id, ...docSnap.data() }));
        allUserPosts = posts;
        renderUserPosts(posts);
      }, (err) => {
        console.error('Realtime posts error:', err);
      });
    }
  
    function renderUserPosts(posts) {
      if (!posts || posts.length === 0) {
        postsContainer.innerHTML = `<div class="empty-state"><h3>No posts yet</h3><p>Click "New Post" to create your first post!</p></div>`;
        return;
      }
      postsContainer.innerHTML = '';
      posts.forEach(p => postsContainer.innerHTML += createPostCardHtml(p.id, p));
    }
  
    function createPostCardHtml(id, post) {
      const date = post.createdAt && post.createdAt.toDate ? post.createdAt.toDate().toLocaleDateString() : (new Date(post.createdAt)).toLocaleDateString();
      const excerpt = (post.content || '').replace(/<\/?[^>]+(>|$)/g, '').slice(0, 240) + (post.content && post.content.length > 240 ? '...' : '');
      const imagesHtml = post.images && post.images.length ? `<div style="display:flex;gap:8px;margin:12px 0">${post.images.map(img=>`<img style="width:80px;height:60px;object-fit:cover;border-radius:8px" src="${img.url}" alt="">`).join('')}</div>`:'';
      return `
        <div class="post-card" id="card-${id}">
          <h3>${escapeHtml(post.title)}</h3>
          ${imagesHtml}
          <div class="post-content">${escapeHtml(excerpt)}</div>
          <div class="post-meta">Posted on ${date}</div>
          <div class="post-actions">
            <button class="btn-small btn-edit" onclick="openPostModal('${id}')">Edit</button>
            <button class="btn-small btn-delete" onclick="deletePost('${id}')">Delete</button>
          </div>
        </div>
      `;
    }
  
    // === Modal open/close & edit population ===
    window.openPostModal = function(postId = null) {
      editingPostId = postId;
      const modal = document.getElementById('post-modal');
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false'); // ✅ FIX: Set aria-hidden correctly
      
      document.getElementById('modal-title').textContent = postId ? 'Edit Post' : 'Create New Post';
      document.getElementById('submit-btn').textContent = postId ? 'Update Post' : 'Publish Post';
  
      // reset staged images
      stagedImages = [];
      renderStagedImages();
  
      if (postId) {
        // populate
        const post = allUserPosts.find(p => p.id === postId);
        if (post) {
          document.getElementById('post-title').value = post.title || '';
          editor.innerHTML = post.content || '';
          if (Array.isArray(post.images)) {
            stagedImages = post.images.map((i, idx) => ({
              file: null,
              localPreview: i.url,
              urlPreview: i.url,
              cloudPublicId: i.path || i.publicId || null,
              name: i.name || ('img_'+idx),
              order: i.order != null ? i.order : idx,
              isInline: false // Gallery images are not inline
            }));
            renderStagedImages();
          }
        }
      } else {
        document.getElementById('post-title').value = '';
        editor.innerHTML = '';
      }
    };
  
    window.closePostModal = function() {
      const modal = document.getElementById('post-modal');
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true'); // ✅ FIX: Set aria-hidden correctly
      editingPostId = null;
      stagedImages = [];
      renderStagedImages();
    };
  
    // === file input handling ===
    function handleMultiSelect(e) {
      const files = Array.from(e.target.files || []);
      for (const f of files) {
        const previewUrl = URL.createObjectURL(f);
        stagedImages.push({ 
          file: f, 
          localPreview: previewUrl, 
          urlPreview: previewUrl, 
          cloudPublicId: null, 
          name: f.name, 
          order: stagedImages.length,
          isInline: false // Gallery images
        });
      }
      renderStagedImages();
      e.target.value = '';
    }
  
    function renderStagedImages() {
      const preview = document.getElementById('image-preview');
      if (!preview) return;
      preview.innerHTML = '';
      
      // Only show non-inline images in the preview area
      const galleryImages = stagedImages.filter(img => !img.isInline);
      galleryImages.sort((a,b)=> (a.order||0)-(b.order||0));
      
      galleryImages.forEach((img, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb';
        div.innerHTML = `
          <img src="${img.urlPreview}" alt="${escapeHtml(img.name)}">
          <button class="remove" title="Remove" onclick="removeStagedImage(${stagedImages.indexOf(img)})">✕</button>
          <button class="move" title="Move left" onclick="moveImageLeft(${stagedImages.indexOf(img)})">◀</button>
          <button class="move move-right" title="Move right" onclick="moveImageRight(${stagedImages.indexOf(img)})">▶</button>
        `;
        preview.appendChild(div);
      });
    }
  
    window.removeStagedImage = function(index) {
      const removed = stagedImages.splice(index,1);
      // revoke object URL if created
      if (removed[0] && removed[0].file && removed[0].localPreview && removed[0].localPreview.startsWith('blob:')) {
        URL.revokeObjectURL(removed[0].localPreview);
      }
      // reassign orders
      stagedImages.forEach((s,i)=> s.order = i);
      renderStagedImages();
    };
  
    window.moveImageLeft = function(index) {
      if (index <= 0) return;
      [stagedImages[index-1], stagedImages[index]] = [stagedImages[index], stagedImages[index-1]];
      stagedImages.forEach((s,i)=> s.order=i);
      renderStagedImages();
    };
  
    window.moveImageRight = function(index) {
      if (index >= stagedImages.length-1) return;
      [stagedImages[index+1], stagedImages[index]] = [stagedImages[index], stagedImages[index+1]];
      stagedImages.forEach((s,i)=> s.order=i);
      renderStagedImages();
    };
  
    // ✅ IMPROVED: inline image insertion with proper tracking
    function triggerImageInsert() {
      const el = document.getElementById('insert-image-file');
      if (el) el.click();
    }
  
    async function handleInsertImage(e) {
      const f = e.target.files[0];
      if (!f) return;
      
      const preview = URL.createObjectURL(f);
      
      // Create img element with data attributes to track it
      const img = document.createElement('img');
      img.src = preview;
      img.alt = f.name;
      img.style.maxWidth = '100%';
      img.style.display = 'block';
      img.style.margin = '10px 0';
      img.dataset.tmpFile = 'true';
      img.dataset.fileName = f.name;
      
      // Store the file in stagedImages for upload
      const imageIndex = stagedImages.length;
      stagedImages.push({ 
        file: f, 
        localPreview: preview, 
        urlPreview: preview, 
        cloudPublicId: null, 
        name: f.name, 
        order: imageIndex,
        isInline: true // Mark as inline image
      });
      
      img.dataset.imageIndex = imageIndex;
      
      // Insert at caret position in editor
      insertNodeAtCaret(img);
      
      // Update the staged images preview (won't show inline images)
      renderStagedImages();
      
      e.target.value = '';
    }
  
    function insertNodeAtCaret(node) {
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount) {
        editor.appendChild(node);
        editor.appendChild(document.createElement('br'));
        return;
      }
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(node);
      
      // Add a line break after the image
      const br = document.createElement('br');
      range.setStartAfter(node);
      range.insertNode(br);
      
      // Move caret after line break
      range.setStartAfter(br);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
  
    // simple format commands
    window.formatText = function(cmd) {
      if (cmd === 'createLink') {
        const url = prompt('Enter URL');
        if (url) document.execCommand('createLink', false, url);
      } else {
        document.execCommand(cmd, false, null);
      }
    };
  
    // ✅ IMPROVED: Cloudinary upload with better error handling
    async function uploadImageToCloudinary(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  
      try {
        const response = await fetch(CLOUDINARY_URL, {
          method: "POST",
          body: formData,
        });
  
        const data = await response.json();
        
        // Check for errors first
        if (data.error) {
          console.error("❌ Cloudinary error:", data.error);
          throw new Error(`Cloudinary error: ${data.error.message || 'Upload failed'}`);
        }
        
        if (data.secure_url && data.public_id) {
          console.log("✅ Image uploaded successfully:", data.secure_url);
          return {
            url: data.secure_url,
            publicId: data.public_id
          };
        } else {
          console.error("❌ Cloudinary upload failed - no URL returned:", data);
          throw new Error("Cloudinary upload failed - no URL returned");
        }
      } catch (error) {
        console.error("❌ Upload error:", error);
        throw error;
      }
    }
  
    // ✅ IMPROVED: publish / update logic with inline image support
    async function handlePostSubmit(e) {
      e.preventDefault();
      const title = document.getElementById('post-title').value.trim();
      if (!title) { alert('Title required'); return; }
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = editingPostId ? 'Updating...' : 'Publishing...';
  
      try {
        // 1) Upload any staged images that have file and no cloudPublicI

      // 1) Upload any staged images that have file and no cloudPublicId yet
      for (let i = 0; i < stagedImages.length; i++) {
        const s = stagedImages[i];
        if (s.file && !s.cloudPublicId) {
          const result = await uploadImageToCloudinary(s.file);
          s.cloudPublicId = result.publicId;
          s.urlPreview = result.url;
        }
      }

      // 2) Replace inline editor images with their Cloudinary URLs
      const imgsInEditor = Array.from(editor.querySelectorAll('img[data-tmp-file]'));
      imgsInEditor.forEach((imgEl) => {
        const imageIndex = parseInt(imgEl.dataset.imageIndex);
        if (!isNaN(imageIndex) && stagedImages[imageIndex]) {
          const match = stagedImages[imageIndex];
          if (match.urlPreview && match.urlPreview.startsWith('http')) {
            imgEl.src = match.urlPreview;
            delete imgEl.dataset.tmpFile;
            delete imgEl.dataset.imageIndex;
            delete imgEl.dataset.fileName;
          }
        }
      });

      // Prepare images metadata array for non-inline images only (gallery images)
      const imagesMeta = stagedImages
        .filter(s => !s.isInline)
        .map((s, idx) => ({
          url: s.urlPreview,
          path: s.cloudPublicId || null,
          name: s.name,
          order: idx
        }));

      // prepare post content (HTML with inline images now using Cloudinary URLs)
      const contentHtml = editor.innerHTML;

      if (editingPostId) {
        // update existing
        await updateDoc(doc(db, 'posts', editingPostId), {
          title,
          content: contentHtml,
          images: imagesMeta,
          updatedAt: serverTimestamp()
        });
        alert('Post updated successfully!');
      } else {
        // create new
        await addDoc(collection(db, 'posts'), {
          title,
          content: contentHtml,
          images: imagesMeta,
          authorId: window.currentUser.uid,
          authorName: window.currentUser.displayName || window.currentUser.email,
          likes: [],
          comments: [], // ✅ Initialize comments array
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        alert('Post published successfully!');
      }

      closePostModal();
    } catch (err) {
      console.error('Error saving post:', err);
      alert('Failed to save post. Check console.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = editingPostId ? 'Update Post' : 'Publish Post';
    }
  }

  // === delete post (keeps behavior same; storage cleanup skipped) ===
  window.deletePost = async function(postId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;
    try {
      const docRef = doc(db, 'posts', postId);
      await deleteDoc(docRef);
      alert('Post deleted successfully!');
    } catch (err) {
      console.error('Error deleting post:', err);
      alert('Failed to delete post. Check console.');
    }
  };

  // === logout ===
  async function handleLogout() {
    if (!confirm('Are you sure you want to logout?')) return;
    try {
      await signOut(auth);
      window.location.href = 'auth.html';
    } catch (err) {
      console.error('Logout error', err);
      alert('Failed to logout.');
    }
  }

  // attach handleLogout to window now that the function exists
  window.handleLogout = handleLogout;

  // === utility ===
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // close modal by background click
  const postModalEl = document.getElementById('post-modal');
  if (postModalEl) {
    postModalEl.addEventListener('click', function(e) {
      if (e.target === this) closePostModal();
    });
  }
  document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closePostModal(); });

  // expose some functions globally so inline onclicks work (create, edit, delete)
  window.handlePostSubmit = handlePostSubmit;
  window.removeStagedImage = window.removeStagedImage;
  window.moveImageLeft = window.moveImageLeft;
  window.moveImageRight = window.moveImageRight;
  window.handleMultiSelect = handleMultiSelect;
  window.triggerImageInsert = triggerImageInsert;
  window.handleInsertImage = handleInsertImage;
</script>  


</body>
</html>
